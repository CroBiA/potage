<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui" xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">

    <f:view contentType="text/html">        
        <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
        <h:head>
            <h:outputStylesheet  library="css" name="css1.css"/>
            <link rel="shortcut icon" type="image/x-icon" href="images/favicon1.ico"/>

            <f:facet name="first">
                <meta content='text/html; charset=UTF-8' http-equiv="Content-Type"/>
                <title>POTAGE - Popseq Ordered Triticum Aestivum Gene Expression</title>
            </f:facet>


            <p:idleMonitor timeout="3600000" >
                <p:ajax event="idle" listener="#{loginController.timeout()}"/>
            </p:idleMonitor>
        </h:head>
        <h:outputStylesheet  library="css" name="css1.css"/>
        <body  onresize="updatechartpanel">



        <h:outputLabel  value="#{counterBean.recordStats}"/>





        <h:form id="formMenu"  >                
            <!--<img class="logos" alt="ACPFG banner" src="Styles/acpfg-diddle.gif" />-->
            <!--<img class="logos" src="Styles/bar.png" alt="" style="height: 30px; width: 100%"/>-->
            <p:dock  id="dock" model="#{mainBean.menuModelSimple}" position="top" itemWidth="38" maxWidth="65" proximity="80"     />                          
        </h:form>

        <p:spacer id="dummyForOverlay" width="100%" height="90"  />




        <p:dialog modal="true" widgetVar="blockUI" draggable="false" closable="false" resizable="false" showHeader="false" 
                  showEffect="#{effectsBean.effectType}" hideEffect="#{effectsBean.effectType}">
            <p:ajax update="@this" process="@this" />
            <p:graphicImage value="/images/ajax-loader#{randomBean.getRandom(13)}.gif" />  
        </p:dialog> 

        <p:growl id="growl" showDetail="true" life="9000"  /> 







        <p:dialog  id="helpDialog" header="Help and information" widgetVar="helpPanel" modal="false"  styleClass="logos" fitViewport="true" 
                   showEffect="scale" hideEffect="fade"  draggable="true" closable="true"  resizable="false" closeOnEscape="true" width="750" height="550">


            <h2> <u>POTAGE</u> - PopSeq Ordered Triticum Aestivum Gene Expression  </h2>

            <h4> Last updated May 2016 </h4>
            <ul> 
                <li> Please report bugs to  <a href="mailto:radoslaw.suchecki@acpfg.com.au?Subject=POTAGE" target="_top">Rad Suchecki</a> </li>
            </ul>

            <h3>Words of caution</h3>
            <ul> 
                <li>The FPKM counts are computed per MIPS gene prediction and to a large extent rely on the correctness of the predictions.  </li>
                <li>Occasionally, two separate genes may fall under one Traes ID and in such cases the associated annotation and FPKM values may be quite misleading. </li>
            </ul>

            <h3> POTAGE functionality depends on:</h3>

            <h4> PopSeq </h4>
            <ul> 
                <li> Utilizes whole genome sequencing for genotyping to establish maker order from sequencing data </li>
                <li> 
                    Provides the genetic anchoring of the IWGSC survey sequences by population sequencing. For more details, see <a href="http://onlinelibrary.wiley.com/doi/10.1111/tpj.12319/abstract" target="_blank">Anchoring and ordering NGS contig assemblies by population sequencing (POPSEQ), Plant J. 76(4) 718-727</a>  
                    Please note that: 
                </li>
                <ul>
                    <li>Number of contigs per cM interval is dependent on recombination frequency </li>
                    <li>The resolution of a genetic map is dependent on the population size</li>
                </ul>
            </ul>

            <h4>High Confidence (HC) wheat gene predictions (a.k.a MIPS gene predictions)</h4> 
            <ul> 
                <li>
                    Described in <a href="http://www.sciencemag.org/content/345/6194/1251788.abstract" target="_blank">A chromosome-based draft sequence of the hexaploid bread wheat (Triticum aestivum) genome, Science 18 July 2014, Vol. 345 no. 6194</a>
                </li>
                <li>
                    POTAGE utilizes <a href="ftp://ftpmips.helmholtz-muenchen.de/plants/wheat/IWGSC/genePrediction_v2.1/" target="_blank">version 2.1 </a> 
                </li>
            </ul>
            <h4>Functional annotation</h4> 
            <ol> 
                <li>MIPS annotation provided with the HC predictions</li>
                <li>Rice-derived annotation, obtained by</li>                
                <ul>
                    <li>
                        Aligning HC coding sequences to rice proteins from <a href="http://rapdb.dna.arc.go.jp" target="_blank">International Rice Genome Sequencing Project (2005), </a> 
                        <a href="http://www.nature.com/nature/journal/v436/n7052/abs/nature03895.html" target="_blank">The map-based sequence of the rice genome. Nature 436: 793–800</a>
                    </li>
                    <li>Annotation retrieved from top rice hits if available and if alignment quality thresholds were met.</li>
                </ul>
            </ol>

            <h4>RNASeq data </h4> 
            <ul> 
                <li>
                    <a href="http://wheat-urgi.versailles.inra.fr/Seq-Repository/RNA-Seq" target="_blank"> Chinese Spring (public)</a>.
                    Non-oriented library (TruSeq, Illumina) sequenced on Illumina HiSeq2000 2x100bp (PE) for 15 different conditions corresponding to five wheat organs (root, leaf, stem, spike, grain) at three developmental stages each in 2 duplicates
                    <table>
                        <tr><td></td></tr>
                        <tr><td>Stage</td><td>Wheat growth stage</td><td>Feekes scale</td><td>Zadoks scale</td><td>Leaves</td><td>Root</td><td>Stem</td><td>Spike</td><td>Grain</td></tr>
                        <tr><td>Seedling</td><td>First leaf through coleoptile</td><td>1</td><td>10</td><td>x</td><td>x</td><td></td><td></td><td></td></tr>
                        <tr><td>Three leaves</td><td>3 leaves unfolded</td><td></td><td>13</td><td></td><td>x</td><td></td><td></td><td></td></tr>
                        <tr><td>Three tillers</td><td>Main shoot and 3 tillers</td><td></td><td>23</td><td>x</td><td></td><td></td><td></td><td></td></tr>
                        <tr><td>Spike at 1 cm</td><td>Pseudostem erection</td><td>5</td><td>30</td><td></td><td></td><td>x</td><td></td><td></td></tr>
                        <tr><td>Two nodes</td><td>2nd detectable node</td><td>7</td><td>32</td><td></td><td></td><td>x</td><td>x</td><td></td></tr>
                        <tr><td>Meiosis</td><td>Flag leaf ligule and collar visible</td><td>9</td><td>39</td><td></td><td>x</td><td></td><td>x</td><td></td></tr>
                        <tr><td>Anthesis</td><td>1/2 of flowering complete</td><td></td><td>65</td><td></td><td></td><td>x</td><td>x</td><td></td></tr>
                        <tr><td>2 DAAs</td></tr>
                        <tr><td>(50°C.days)"</td><td>Kernel (caryopsis) watery ripe</td><td></td><td>71</td><td>x</td><td></td><td></td><td></td><td>x</td></tr>
                        <tr><td>14 DAAs</td></tr>
                        <tr><td>(350°C.days)"</td><td>Medium Milk</td><td></td><td>75</td><td></td><td></td><td></td><td></td><td>x</td></tr>
                        <tr><td>30 DAAs</td></tr>
                        <tr><td>(700°C.days)"</td><td>Soft dough</td><td></td><td>85</td><td></td><td></td><td></td><td></td><td>x</td></tr>
                        <tr><td></td></tr>
                    </table>
                </li>
                <li>Chinese Spring/Cornerstone (ACPFG in-house). Anthers, four developmental stages. Single end reads only.</li>
                <li>Chris (ACPFG in-house). Anther, seedling, Illumina 2x100bp (PE)</li>
                <li>Drought experiment (ACPFG in-house)</li>
                <ul>
                    <li>Excalibur and RAC875</li>                    
                    <li>3, 5, 9 days after anthesis</li>                    
                    <li>Well-watered (WW), Mild-drought(MD), Severe-drought(SD)</li>                    
                </ul>
            </ul>




        </p:dialog>

        <p:dialog  id="searchDialog" header="Search for sequence on all chromosomes (by ID)" widgetVar="searchPanel" modal="false" position="left+25%,top+25%" 
                   showEffect="scale" hideEffect="fade"  draggable="true" closable="true"  resizable="false" closeOnEscape="true" width="650" height="160">
            <h:form id="formSearch">
                <p:toolbar >                        
                    <f:facet name="left">
                        <p:inputText id="idInput" widgetVar="idInput" style="width:300px" placeholder="Enter IWGSC SS identifier or a MIPS gene ID" value="#{mainBean.userQuery}"  />
                    </f:facet>
                    <f:facet name="right">
                        <p:commandButton  value="Search" id="searchButton" actionListener="#{mainBean.searchAll}" icon="ui-icon-search" update="idInput,searchMessages,:formCentre:dataTable,:formCentre:chartsGrid,:formSearch3:contigList" 
                                          onstart="PF('blockUI').show()" oncomplete="PF('blockUI').hide();if(args.showContigList){PF('allContigsDialog').show()}"/>                        
                        <p:commandButton value="Clear" id="clearSearch" icon="ui-icon-cancel" update="idInput,searchMessages,:formCentre:dataTable,:formCentre:chartsGrid" process="@this" actionListener="#{mainBean.setUserQuery('')}" oncomplete="PF('dataTable').filter()"/>
                    </f:facet>
                </p:toolbar>
                <p:messages id="searchMessages" showDetail="true"  closable="true"  redisplay="false"  />
            </h:form>
        </p:dialog> 

        <h:form id="formUpload">
            <p:overlayPanel widgetVar="uploadPanel" for=":formSearch2:tabView:uploadButton" hideEffect="fade"  hideEvent="mousedown" showEffect="scale" at="top"                            
                            showCloseIcon="true" dismissable="true"   >
                <p:fileUpload widgetVar="fileUpload" fileUploadListener="#{mainBean.handleFileUpload}"  mode="advanced" auto="true" allowTypes="/(\.|\/)(fa|fasta|fas|txt|fst)$/" 
                              label="Choose a FASTA file to upload" sizeLimit="10485760" invalidSizeMessage="The maximum file size allowed is 10MB!" oncomplete="PF('uploadPanel').hide()"  
                              invalidFileMessage="Only upload FASTA files!" multiple="false"  update=":formSearch2:searchMessages2,:formSearch2:tabView:seqInput"/>
            </p:overlayPanel>
        </h:form>          


        <p:dialog  id="searchSeqDialog" header="Search all chromosomes by aligning a sequence" widgetVar="searchSeqPanel" modal="false" position="80,140" minimizable="true" 
                   showEffect="scale" hideEffect="fade"  draggable="true" closable="true"  resizable="false" closeOnEscape="true" width="850" height="550">

            <h:form id="formSearch2">
                <p:tabView id="tabView" activeIndex="#{mainBean.seqSearchTabActive}"    >
                    <p:tab title="Input"  >
                        <p:toolbar >
                            <f:facet name="left">
                                <p:commandButton  id="uploadButton" value="Upload FASTA file..." icon="ui-icon-arrowreturnthick-1-s" onclick="PF('uploadPanel').show();" /> 
                            </f:facet>                                    
                            <f:facet name="right">
                                <p:commandButton  value="Search" id="searchSeqButton" actionListener="#{mainBean.sequenceSearchEventHandler}" icon="ui-icon-search" 
                                                  onstart="PF('blockUI').show();"  
                                                  oncomplete="PF('blockUI').hide();"
                                                  update="seqInput,:formSearch2:searchMessages2,:formCentre:dataTable,tabView" />                        
                                <p:commandButton value="Clear" id="clearSeqSearch" icon="ui-icon-cancel" update="seqInput,:formSearch2:searchMessages2,:formCentre:dataTable,tabView" process="@this" actionListener="#{mainBean.clearFileContentString()}" oncomplete="PF('dataTable').filter();" />
                            </f:facet>
                        </p:toolbar>
                        <p:inputTextarea id="seqInput" widgetVar="seqInput" style="min-height: 250px;width: 98.5%;alignment-adjust: central; resize: none" autoResize="false" 
                                         placeholder="Enter a FASTA nucleotide sequence"  
                                         value="#{mainBean.fileContentString}" ondblclick="PF('uploadPanel').show()" />                            
                    </p:tab>
                    <p:tab title="Results - summary" disabled="#{!mainBean.hasHitsForQueryDataModel()}" >
                        <p:dataTable id="allresults" var="query" value="#{mainBean.hitsForQueryDataModel}" paginator="true" rows="5" rowsPerPageTemplate="5,10,15"   
                                     selection="#{mainBean.selectedQuery}"  selectionMode="single" paginatorAlwaysVisible="false" >  
                            <p:ajax event="rowSelect" update=":formSearch2:tabView"  />  
                            <f:facet name="header">  
                                Select a row to display hits retrieved for the corresponding query  
                            </f:facet>  

                            <p:column headerText="View" width="10%" >  
                                <p:commandButton id="selectButton" update=":formSearch2:tabView" icon="ui-icon-search" title="View">
                                    <f:setPropertyActionListener value="#{query}" target="#{mainBean.selectedQuery}" />
                                </p:commandButton>
                            </p:column>

                            <p:column headerText="Query ID" width="75%" >  
                                <!--<h:outputLabel value="#{query.getColoredQueryId()} " escape="false"/>-->
                                #{query.getFormatedQueryId()}
                            </p:column>  
                            <p:column headerText="Number of hits" width="15%" >  
                                <h:outputText value="#{query.getNumbPromotersA()}" escape="false"/>
                            </p:column>  
                        </p:dataTable>
                    </p:tab>
                    <p:tab title="Results - per query" disabled="#{!mainBean.hasHitsDataModel()}">
                        <h:panelGrid columns="2" cellpadding="4">  
                        </h:panelGrid>  

                        <p:dataTable var="hit" value="#{mainBean.hitsDataModel}" paginator="true" rows="5"  selectionMode="single"
                                     selection="#{mainBean.selectedHit}" paginatorAlwaysVisible="false" >  
                            <f:facet name="header">  
                                <h:outputText value="#{mainBean.selectedQuery.getNumbPromotersB()} hits retrieved for the selected query : #{mainBean.selectedQuery.queryId}" escape="false"/>
                            </f:facet>  
                            <p:ajax event="rowSelect" onstart="PF('blockUI').show();" oncomplete="PF('blockUI').hide();if(args.showContigList){PF('allContigsDialog').show()}"  
                                    update=":formCentre:dataTable,:formSearch:idInput,:formSearch2:searchMessages2,:formCentre:chartsGrid,:formSearch3:contigList" />
                            <p:column style="width:7%" >
                                <p:commandButton id="selectButton3" icon="ui-icon-search" update=":formCentre:dataTable,:formSearch:idInput,:formSearch2:searchMessages2,:formCentre:chartsGrid,:formSearch3:contigList" 
                                                 onstart="PF('blockUI').show()" oncomplete="PF('blockUI').hide();if(args.showContigList){PF('allContigsDialog').show()}">
                                    <f:setPropertyActionListener value="#{hit}" target="#{mainBean.selectedHit}" />
                                </p:commandButton>                            
                            </p:column>

                            <p:column headerText="Hit contig ID" style="width:14%; text-align: center">  
                                #{hit.hitId}  
                            </p:column>  
                            <p:column headerText="Coordinates" style="width:18%; text-align: center">  
                                <h:outputText value=" #{hit.getContigCoordinatesHTML()}" escape="false"/>
                            </p:column>  
                            <p:column headerText="orientation" style="width:10%; text-align: center">  
                                #{hit.getFrames()}  
                            </p:column>  
                            <p:column headerText="full query identity" style="width:15%; text-align: center">  
                                <h:outputText value="#{hit.getPercIdOverQlen()}" escape="false" />
                            </p:column>  
                            <p:column headerText="aligned query identity" style="width:15%; text-align: center">  
                                <h:outputText value="#{hit.getPercIdOverAlignedQlen()}" escape="false" />
                            </p:column>  
                            <p:column headerText="query aligned" style="width:15%; text-align: center">  
                                <h:outputText value="#{hit.getPercQueryAligned()}" escape="false"/>
                            </p:column>  

                        </p:dataTable>  
                    </p:tab>
                </p:tabView>
                <p:messages id="searchMessages2" showDetail="true"  closable="true" redisplay="false"     />
            </h:form>
        </p:dialog> 



        <p:dialog  id="allContigsDialog" header="All contigs within a cM range..." widgetVar="allContigsDialog" modal="false" minimizable="true"  
                   showEffect="scale" hideEffect="fade"  draggable="true" closable="true"  resizable="false" closeOnEscape="true" width="850" height="550">

            <h:form id="formSearch3">
                <p:spacer height="10" width="0" />

             <!--filteredValue="#{mainBean.perLocationContigs.filteredContigs}"--> 
                <p:dataTable id="contigList" widgetVar="contigList" value="#{mainBean.perLocationContigs.contigs}" var="contig" style="text-align: center" 
                             selection="#{mainBean.perLocationContigs.selectedContigs}" rowKey="#{contig.id}"  
                             rowStyleClass="#{mainBean.contains(mainBean.userQuery, contig.contigId) ? 'highlighted' : null}" 
                             paginator="true" rows="10" paginatorAlwaysVisible="true"  styleClass="paginated"
                             paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}">
                    <f:facet name="header">
                        <p:toolbar>
                            <f:facet name="left">
                                <h:outputText value="List contigs on chromosome " />
                                <p:autoComplete dropdown="true" value="#{mainBean.chromosomeForNonGeneContigs}" completeMethod="#{trivialBean.getChromosomes()}"  
                                                forceSelection="true" size="2" >
                                    <p:ajax event="itemSelect" listener="#{mainBean.loadAllContigs()}" update=":formSearch3:contigList" 
                                            process="@this" onstart="PF('blockContigList').show();" oncomplete="PF('blockContigList').hide();" />
                                </p:autoComplete> 
                                <p:spacer height="0" width="10" />
                                <h:outputText value="between " />                                
                                <p:autoComplete dropdown="true" value="#{mainBean.perLocationContigs.cM_filterForNonGeneContigs.cM_min_user}" 
                                                completeMethod="#{mainBean.perLocationContigs.rangePrefix}" 
                                                disabled="#{!mainBean.perLocationContigs.dataLoaded}"
                                                forceSelection="true" size="7" scrollHeight="400" immediate="true"  >
                                    <p:ajax event="itemSelect" update=":formSearch3:contigList" process="@this"  
                                            oncomplete="PF('contigList').filter();" />
                                </p:autoComplete>
                                <p:spacer height="0" width="10" />
                                <h:outputText value=" and  " />
                                <p:autoComplete dropdown="true" value="#{mainBean.perLocationContigs.cM_filterForNonGeneContigs.cM_max_user}" 
                                                completeMethod="#{mainBean.perLocationContigs.rangePrefix}" 
                                                disabled="#{!mainBean.perLocationContigs.dataLoaded}"
                                                forceSelection="true" size="7" scrollHeight="400" immediate="true">                                    
                                    <p:ajax event="itemSelect" update=":formSearch3:contigList" process="@this"  
                                            oncomplete="PF('contigList').filter();" />
                                </p:autoComplete>
                                <p:spacer height="0" width="5" />
                                <h:outputText value=" cM" />
                            </f:facet>
                            <f:facet name="right">
                                <p:commandButton title="Reset cM filtering" value="Reset cM filtering" icon="ui-icon-cancel" update=":formSearch3:contigList" 
                                                 process="@this" action="#{mainBean.perLocationContigs.resetFilter()}" 
                                                 oncomplete="PF('contigList').filter();" 
                                                 disabled="#{!mainBean.perLocationContigs.isFiltered()}" />
                            </f:facet>
                        </p:toolbar>
                        <p:blockUI block="contigList" widgetVar="blockContigList" />        
                    </f:facet>
                    <p:column selectionMode="multiple" style="width:16px;text-align:center"/>
                    <p:column headerText="Contig ID"  >                        
                        <h:outputText value="#{contig.contigId}" />                        
                    </p:column>                     
                    <p:column headerText="cM" filterBy="#{contig.cM}" filterFunction="#{mainBean.perLocationContigs.filterByCm}">
                        <f:facet name="filter">
                            <h:inputHidden id="cM_range" value="#{mainBean.perLocationContigs.cM_filterForNonGeneContigs.cM_range_user}" />
                        </f:facet>
                        <h:outputText value="#{contig.cM}" />                        
                    </p:column>                     
<!--                    <p:column headerText="cM (min)" filterBy="#{contig.cM}" filterMatchMode="gte">
                        <f:facet name="filter">
                            <p:autoComplete dropdown="true" value="#{mainBean.perLocationContigs.cM_filterForNonGeneContigs.cM_min_user}" 
                                            completeMethod="#{mainBean.perLocationContigs.rangePrefix}" 
                                            forceSelection="true" size="7" scrollHeight="400"  >
                                <p:ajax event="itemSelect" process="@this" update=":formSearch3:contigList"
                                        oncomplete="PF('contigList').filter()" />                                        
                                <f:converter converterId="javax.faces.Double" />
                            </p:autoComplete>
                        </f:facet>
                        <h:outputText value="#{contig.cM}" />                        
                    </p:column>                     -->
<!--                    <p:column headerText="cM (max)" filterBy="#{contig.cM}" filterMatchMode="lte" >     
                        <f:facet name="filter" >
                            <p:autoComplete dropdown="true" value="#{mainBean.perLocationContigs.cM_filterForNonGeneContigs.cM_max_user}" 
                                            completeMethod="#{mainBean.perLocationContigs.rangePrefix}" 
                                            forceSelection="true" size="7" scrollHeight="400"  >
                                <p:ajax event="itemSelect" process="@this" update=":formSearch3:contigList"
                                        oncomplete="PF('contigList').filter()" />
                                <f:converter converterId="javax.faces.Double" />
                            </p:autoComplete>
                        </f:facet>
                        <h:outputText value="#{contig.cM}" />                        
                    </p:column>                     -->
                    <p:ajax event="filter" process="@this" onstart="PF('blockContigList').show();" oncomplete="PF('blockContigList').hide();"/>  
                    <p:ajax event="rowSelect" update="contigExportToolbar" process="@this"/>  
                    <p:ajax event="rowUnselect" update="contigExportToolbar" process="@this"/>
                    <p:ajax event="toggleSelect" update="contigExportToolbar" process="@this"/>
                    <p:ajax event="rowSelectCheckbox" update="contigExportToolbar" process="@this"/>
                    <p:ajax event="rowUnselectCheckbox" update="contigExportToolbar" process="@this"/>
                    <f:facet name="footer">
                        <p:toolbar id="contigExportToolbar"  >
                            <f:facet name="left">
                                <p:commandButton value="Clear selection"  icon="ui-icon-cancel" action="#{mainBean.perLocationContigs.clearSelectedContigs()}" onstart="PF('blockContigList').show();"   
                                                 oncomplete="PF('blockContigList').hide();" title="Clear record selection" disabled="#{!mainBean.perLocationContigs.somethingSelected()}" 
                                                 update=":formSearch3:contigList" >                            
                                </p:commandButton> 
                                <p:spacer width="15" height="1" />
                                <p:commandButton value="Save selected contig(s)"  icon="ui-icon-disk" onclick="PF('statusDialog').show();"   
                                                 title="Save the selected IWGSC contig(s) to a FASTA file" disabled="#{!mainBean.perLocationContigs.somethingSelected()}" ajax="false" >                            
                                    <p:fileDownload value="#{mainBean.perLocationContigs.exportFileWholeIWGSC}"     />                                
                                </p:commandButton>
                            </f:facet>

                            <f:facet name="right">

                                <h:outputLabel value="Export " escape="false" style="vertical-align: middle;" />
                                <p:selectOneMenu value="#{mainBean.perLocationContigs.toExport}" style="vertical-align: middle; text-align: left; width: 120px" disabled="#{!mainBean.perLocationContigs.dataLoaded}"   >
                                    <f:selectItem itemLabel="current page" itemValue="page" />
                                    <f:selectItem itemLabel="whole table" itemValue="all"/>
                                    <p:ajax update="exportCSV"/>  
                                </p:selectOneMenu>
                                <!--                                    <f:selectItem itemLabel="selected rows" itemValue="selected" />-->
                                <h:commandLink id="exportCSV" disabled="#{mainBean.perLocationContigs.exportDsiabled()}" onclick="PF('statusDialog').show();">
                                    <p:graphicImage value="/images/csv_text.png" style="vertical-align: middle;" title="Export table to a CSV file." rendered="#{!mainBean.perLocationContigs.exportDsiabled()}"/>
                                    <p:graphicImage value="/images/csv_text_grey.png" style="vertical-align: middle;" title="Export table to a CSV file." rendered="#{mainBean.perLocationContigs.exportDsiabled()}"/>
                                    <p:dataExporter type="csv" target="contigList" fileName="Contigs_table_#{randomBean.getRandomFilename()}" pageOnly="#{mainBean.perLocationContigs.exportPageOnly()}" 
                                                    selectionOnly="#{mainBean.perLocationContigs.exportSelectedOnly()}"/>
                                </h:commandLink>
                            </f:facet>
                        </p:toolbar>
                    </f:facet>
                </p:dataTable>
            </h:form>

        </p:dialog>



<!--<p:slideMenu model="#{mainBean.menuModel}" style="width: 110pt" />-->
        <!--<p:commandButton type="button" onclick="jQuery('.ui-row-toggler').click()" value="Expand/collapse gene annotation"  />-->


        <h:form id="formCentre" >


            <p:dataTable var="gene" value="#{mainBean.loadedGenes}" styleClass="myTable" 
                         selection="#{mainBean.selectedGenes}"  
                         id="dataTable" widgetVar="dataTable" 
                         filteredValue="#{mainBean.filteredGenes}" 
                         rowKey="#{gene.geneId}" 
                         paginator="true" rows="5" paginatorAlwaysVisible="true" rowsPerPageTemplate="5,10,20,40,80,160" style="text-align: center"
                         paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                         rowStyleClass="#{mainBean.contains(mainBean.userQuery, gene.geneId, gene.contig.contigId) ? 'highlighted' : null}" 
                         reflow="true">
                <p:ajax event="page" onstart="PF('block2Table').show();" oncomplete="PF('block2Table').hide();" process="@this" update="@this"   />    
                <f:facet name="header" >
                    <p:toolbar>
                        <f:facet name="left">
                            <h:outputText value="#{mainBean.currentChromosome}"  />
                        </f:facet>
                        <f:facet name="right">
                            <h:outputText value="Global filter (all text fields on current chromosome):" />
                            <p:inputText id="globalFilter" widgetVar="globalFilter" onkeyup="PF('dataTable').filter()" style="width:150px; color: #fd3506" 
                                         placeholder="Enter keyword" value="#{mainBean.globalFilter}" onfocus="PF('dataTable').filter()"   />
                            <p:commandButton id="filterbutton" icon="ui-icon-check" update="dataTable,:formCentre:chartsGrid"  onclick="PF('dataTable').filter()" />
                            <p:commandButton id="clearbutton" icon="ui-icon-cancel" update="dataTable,:formCentre:chartsGrid" process="@this" action="#{mainBean.setGlobalFilter('')}" 
                                             onstart="PF('blockUI').show();" oncomplete="PF('blockUI').hide();PF('dataTable').filter()"/>                                  
                        </f:facet>
                    </p:toolbar>
                    <p:toolbar>
                        <f:facet name="left" >
                            <h:outputText value="cM between " />
                            <p:autoComplete dropdown="true" value="#{mainBean.cM_filter.cM_min_user}"   disabled="#{!mainBean.dataLoaded}" 
                                            forceSelection="true" size="7" scrollHeight="400" title="Type in the desired cM position (from)"   
                                            completeMethod="#{mainBean.cM_filter.rangePrefix}" >
                                <p:ajax event="itemSelect" update="dataTable" process="@this" listener="#{mainBean.filterByCm}" onstart="PF('blockUI').show();" oncomplete="PF('blockUI').hide();" />
                                <!--<p:ajax event="change" update="dataTable" process="@this" listener="#{mainBean.filterByCm}" onstart="PF('blockUI').show();" oncomplete="PF('blockUI').hide();" />-->
                            </p:autoComplete>
                            <p:spacer height="0" width="35" />
                            <h:outputText value=" and   " />
                            <p:autoComplete dropdown="true" value="#{mainBean.cM_filter.cM_max_user}"   disabled="#{!mainBean.dataLoaded}"
                                            forceSelection="true" size="7"   scrollHeight="400" title="Type in the desired cM position (to)"  
                                            completeMethod="#{mainBean.cM_filter.rangePrefix}" >
                                <p:ajax event="itemSelect" update="dataTable" process="@this" listener="#{mainBean.filterByCm}" onstart="PF('blockUI').show();" oncomplete="PF('blockUI').hide();" />
                                <!--<p:ajax event="change" update="dataTable" process="@this" listener="#{mainBean.filterByCm}" onstart="PF('blockUI').show();" oncomplete="PF('blockUI').hide();" />-->
                            </p:autoComplete>
                            <!--<p:spacer height="0" width="75" />-->
                            <!--                            <h:outputText value="cM (original) between " />
                                                        <p:autoComplete dropdown="true" value="#{mainBean.cM_filter.cM_original_min_user}"   disabled="#{!mainBean.dataLoaded}" 
                                                                        forceSelection="true" size="7" scrollHeight="400" title="Type in the desired cM (original) position (from)"   
                                                                        completeMethod="#{mainBean.cM_filter.originalRangePrefix}" >
                                                            <p:ajax event="itemSelect" update="dataTable" process="@this" listener="#{mainBean.filterByCm()}" onstart="PF('blockUI').show();" oncomplete="PF('blockUI').hide();" />
                                                        </p:autoComplete>
                                                        <p:spacer height="0" width="35" />
                                                        <h:outputText value=" and   " />
                                                        <p:autoComplete dropdown="true" value="#{mainBean.cM_filter.cM_original_max_user}"   disabled="#{!mainBean.dataLoaded}"
                                                                        forceSelection="true" size="7"   scrollHeight="400" title="Type in the desired cM (original) position (to)"  
                                                                        completeMethod="#{mainBean.cM_filter.originalRangePrefix}" >
                                                            <p:ajax event="itemSelect" update="dataTable" process="@this" listener="#{mainBean.filterByCm()}" onstart="PF('blockUI').show();" oncomplete="PF('blockUI').hide();" />
                                                        </p:autoComplete>-->
                            <p:spacer height="0" width="35" />
                            <p:commandButton title="Reset cM filtering" value="Reset cM filtering"  icon="ui-icon-cancel" update=":formCentre:dataTable" process="@this" action="#{mainBean.resetFilter()}" 
                                             onstart="PF('blockTable').show();" oncomplete="PF('blockTable').hide();" disabled="#{!mainBean.isFiltered()}" />

                        </f:facet>
                        <f:facet name="right">
                            <h:outputText value="Append unanchored genes to the end of the table "/>
                            <p:selectBooleanButton value="#{mainBean.appendUnordered}" onLabel="Yes" offLabel="No" onIcon="ui-icon-check" offIcon="ui-icon-close" style="width:60px">
                                <p:ajax update="dataTable" listener="#{mainBean.reload()}"  onstart="PF('blockUI').show();" oncomplete="PF('blockUI').hide();"/>
                            </p:selectBooleanButton>
                        </f:facet>
                    </p:toolbar>

                </f:facet>
                <p:columnGroup type="header" id="headerGroup" >   
                    <p:row > 
                        <p:column rowspan="2" selectionMode="multiple" width="25"  />
                        <p:column rowspan="2" headerText="Expression" width="105"/>  
                        <p:column rowspan="2" headerText="Gene ID"  filterBy="#{gene.geneId}"  filterFunction="#{mainBean.filterIgnoreCaseContains}" width="140"/>
                        <p:column rowspan="2" headerText="From"   width="30"/>
                        <p:column rowspan="2" headerText="To"   width="30"/>
                        <p:column rowspan="2" headerText="+/-"  width="10" id="strand" /> 
                        <p:column rowspan="2" headerText="Contig ID" filterBy="#{gene.contig.contigId}" filterFunction="#{mainBean.filterIgnoreCaseContains}" width="105"/>
                        <p:column rowspan="2" headerText="cM" style="text-align: center"   width="47" />
                        <!--<p:column rowspan="2" headerText="cM original" style="text-align: center" width="45" />-->
                        <p:column colspan="3"  headerText="MIPS Annotation" style="color: peru" />
                        <p:column colspan="2" headerText="Rice-derived Annotation"  style="color: mediumseagreen"/>
                    </p:row>
                    <p:row>
                        <p:column headerText="Hit ID" style="color: peru"  width="120" filterBy="#{gene.annotationMips.hitId}" filterFunction="#{mainBean.filterIgnoreCaseContains}"/>
                        <p:column headerText="Description" style="color: peru" filterBy="#{gene.annotationMips.annotationString}" filterFunction="#{mainBean.filterIgnoreCaseContains}"/>                                        
                        <p:column headerText="InterproID" style="color: peru; wrapClass1" filterBy="#{gene.annotationMips.interpro}" filterFunction="#{mainBean.filterIgnoreCaseContains}"/>
                        <p:column headerText="Hit ID" style="color: mediumseagreen" filterBy="#{gene.annotationRice.hitId}" filterFunction="#{mainBean.filterIgnoreCaseContains}"/>
                        <p:column headerText="Description" style="color: mediumseagreen" filterBy="#{gene.annotationRice.annotationString}" filterFunction="#{mainBean.filterIgnoreCaseContains}"/>
                    </p:row>
                </p:columnGroup>

                <p:column selectionMode="multiple" width="25" exportable="false" />

                <p:column exportable="false">  
                    <p:blockUI block="dataTable" widgetVar="blockTable"   />
                    <p:commandButton icon="ui-icon-newwin" id="view" value="View" onstart="PF('blockTable').show();" oncomplete="PF('blockTable').hide()"  
                                     action="#{mainBean.setGeneSelectedForDialogDisplay(gene)}"/>
                    <p:commandButton icon="ui-icon-arrowthickstop-1-s" title="Add gene to FPKM charts display" onstart="PF('blockUI').show();" oncomplete="PF('blockUI').hide()" 
                                     action="#{mainBean.addGeneToDisplay(gene)}" update=":formCentre:chartsGrid"  />
                </p:column>
                <p:column> <h:outputText value="#{gene.getGeneIdHTML('peru')}" escape="false"/></p:column>
                <p:column> <h:outputText value="#{gene.from}"/></p:column>
                <p:column> <h:outputText value="#{gene.to}"/></p:column>
                <p:column> <h:outputText value="#{gene.strand}"/></p:column>
                <p:column> <h:outputText value="#{gene.contig.contigId}"  />  </p:column>
                <p:column> <h:outputText value="#{gene.contig.cM}  " /> </p:column>
                <!--<p:column> <h:outputText value="#{gene.contig.cM_original}" /> </p:column>-->
                <p:column> <h:outputText value="#{gene.annotationMips.getMipsHTML('peru')}" escape="false"/> </p:column> 
                <p:column> <h:outputText value="#{gene.annotationMips.annotationString}" style="color: peru" /> </p:column>  
                <p:column> 
                    <h:outputText value="#{gene.annotationMips.getInterproHTML('peru')}"  escape="false"/>  
                </p:column>  
                <p:column> <h:outputText value="#{gene.annotationRice.getRiceHTML('mediumseagreen')}" escape="fasle" /> </p:column> 
                <p:column> <h:outputText value="#{gene.annotationRice.annotationString}" style="color: mediumseagreen"/> </p:column>  

                <p:ajax event="rowSelect" update="exportToolbar,:formCentre:chartsGrid" process="@this,:formCentre:chartsGrid" />  
                <p:ajax event="rowUnselect" update="exportToolbar,:formCentre:chartsGrid" process="@this,:formCentre:chartsGrid"/>
                <p:ajax event="toggleSelect" update="exportToolbar,:formCentre:chartsGrid" process="@this,:formCentre:chartsGrid"/>
                <p:ajax event="rowSelectCheckbox" update="exportToolbar,:formCentre:chartsGrid" process="@this,:formCentre:chartsGrid"/>
                <p:ajax event="rowUnselectCheckbox" update="exportToolbar,:formCentre:chartsGrid" process="@this,:formCentre:chartsGrid"/>

                <f:facet name="footer"  > 
                    <p:toolbar id="exportToolbar"  >
                        <f:facet name="left">
                            <p:blockUI block="dataTable" widgetVar="block2Table"    />
                            <p:commandButton value="Add selected to charts display"  icon="ui-icon-arrowthickstop-1-s" action="#{mainBean.addSelectedGenesToDisplay()}" 
                                             onstart="PF('blockUI').show();"   
                                             oncomplete="PF('blockUI').hide();" title="Add selection to charts display" disabled="#{!mainBean.somethingSelected()}" 
                                             update=":formCentre:chartsGrid" >                            
                            </p:commandButton> 


                            <p:spacer width="15" height="1" />
                            <p:commandButton value="Clear selection"  icon="ui-icon-cancel" action="#{mainBean.clearSelectedGenes()}" onstart="PF('block2Table').show();"   
                                             oncomplete="PF('block2Table').hide();" title="Clear record selection" disabled="#{!mainBean.somethingSelected()}" 
                                             update="dataTable,:formCentre:chartsGrid" >                            
                            </p:commandButton> 
                            <p:spacer width="15" height="1" />
                            <p:commandButton value="Save selected contig(s)"  icon="ui-icon-disk" onclick="PF('statusDialog').show();"   
                                             title="Save the selected IWGSC contig(s) to a FASTA file" disabled="#{!mainBean.somethingSelected()}" ajax="false" >                            
                                <p:fileDownload value="#{mainBean.exportFileWholeIWGSC}"     />                                
                            </p:commandButton> 
                        </f:facet>
                        <f:facet name="right"> 
                            <h:outputLabel value="Export " escape="false" style="vertical-align: middle;" />
                            <p:selectOneMenu value="#{mainBean.toExport}" style="vertical-align: middle; text-align: left; width: 120px" disabled="#{!mainBean.dataLoaded}"   >
                                <f:selectItem itemLabel="current page" itemValue="page" />
                                <f:selectItem itemLabel="whole table" itemValue="all"/>
                                <p:ajax update="exportXLS"/>  
                                <!--<f:selectItem itemLabel="selected rows" itemValue="selected" />-->
                            </p:selectOneMenu>
                            <h:commandLink id="exportXLS" disabled="#{mainBean.exportDsiabled()}" onclick="PF('statusDialog').show();">
                                <p:graphicImage value="/images/excel3.png" style="vertical-align: middle;" title="Export to MS Excel format" rendered="#{!mainBean.exportDsiabled()}"/>
                                <p:graphicImage value="/images/excel3grey2.png" style="vertical-align: middle;" title="Export to MS Excel format" rendered="#{mainBean.exportDsiabled()}"/>
                                <p:dataExporter type="xls" target="dataTable" fileName="POTAGE_table_#{randomBean.getRandomFilename()}" pageOnly="#{mainBean.exportPageOnly()}"  
                                                selectionOnly="#{mainBean.exportSelectedOnly()}" postProcessor="#{mainBean.postProcessXLS}"/> 
                            </h:commandLink>
                        </f:facet>
                    </p:toolbar>
                </f:facet>
            </p:dataTable>


            <p:confirmDialog  widgetVar="statusDialog" closable="true" severity="info" message="Download initiated, a file will become available shortly."  style="alignment-adjust: middle"  >                    
                <p:commandButton value="OK" style="width: 100%" type="button" icon="ui-icon-check" onclick="PF('statusDialog').hide()"/> 
            </p:confirmDialog>  


            <p:spacer height="20" />

            <p:dataGrid var="gene" value="#{mainBean.selectedGenesForChartDisplay}" columns="3" rows="6" paginator="true" id="chartsGrid" widgetVar="chartsGrid"
                        emptyMessage="No genes selected for display." 
                        paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                        rowsPerPageTemplate="3,6,9" >
                <p:ajax event="page" onstart="PF('blockUI').show();" oncomplete="PF('blockUI').hide();" />   
                <f:facet name="header" >
                    <p:toolbar>
                        <f:facet name="left">
                            <h:outputText value="FPKM charts for selected genes"  />
                        </f:facet>
                        <f:facet name="right">
                            <p:commandButton id="clearCharts" widgetVar="clearCharts" value="Clear charts display"  icon="ui-icon-cancel" action="#{mainBean.clearSelectedGenesForChartDisplay()}" 
                                             onstart="PF('blockUI').show();"   oncomplete="PF('blockUI').hide();" title="Clear charts display" 
                                             disabled="#{mainBean.hasNoGenesSelectedForDisplay()}" update=":formCentre:chartsGrid"/> 
                        </f:facet>
                    </p:toolbar>
                </f:facet>
                <p:panel header="#{gene.geneId}  on  #{gene.contig.contigId}" style="text-align:center;"   >
                    <p:tabView id="chartsTabView" value="#{gene.chartModels}" var="chartModel"  >
                        <p:ajax event="tabChange" update="chartsTabView" listener="#{gene.onTabChange}"/>
                        <p:tab title="#{chartModel.getTitle()}">
                            <p:chart type="bar" model="#{chartModel.model}" widgetVar="#{chartModel.chartId}"   />
                        </p:tab>
                    </p:tabView>

                    <!--                    <p:tabView id="chartsTabView" >
                                            <p:ajax event="tabChange" update="chartsTabView" listener="#{gene.onTabChange}"/>
                                            <p:tab title="Chinese Spring">
                                                <p:chart type="bar" model="#{gene.getBarChartModel(0)}" widgetVar="chart_0_#{gene.geneId}"   >
                                                    <p:ajax event="itemSelect" listener="#{mainBean.chartItemSelect}"/>
                                                </p:chart>                            
                                            </p:tab>
                                            <p:tab title="Cultivar X">
                                            <p:tab title="Chris">
                                                <p:chart type="bar" model="#{gene.getBarChartModel(1)}" widgetVar="chart_1_#{gene.geneId}"  />
                                            </p:tab>
                                            <p:tab title="Cultivar Y">
                                            <p:tab title="Cornerstone/CS">
                                                <p:chart type="bar" model="#{gene.getBarChartModel(2)}" widgetVar="chart_2_#{gene.geneId}"  />
                                            </p:tab>
                                            <p:tab title="Excalibur">
                                                <p:chart type="bar" model="#{gene.getBarChartModel(3)}" widgetVar="chart_3_#{gene.geneId}"  />
                                            </p:tab>
                                            <p:tab title="RAC875">
                                                <p:chart type="bar" model="#{gene.getBarChartModel(4)}" widgetVar="chart_4_#{gene.geneId}"  />
                                            </p:tab>
                                        </p:tabView>-->
                    <f:facet name="actions" >
                        <p:commandButton icon="ui-icon-trash" action="#{mainBean.removeFromChartDisplay(gene)}" onstart="PF('blockUI').show();"   
                                         oncomplete="PF('blockUI').hide();" title="Remove chart" process=":formCentre:chartsGrid" 
                                         update=":formCentre:chartsGrid" styleClass="ui-panel-titlebar-icon ui-corner-all ui-state-default"/>   
                        <p:commandButton icon="ui-icon-image" action="#{gene.exportChart(gene)}"    
                                         oncomplete="exportChart(xhr, status, args);" title="Export chart as image"  
                                         styleClass="ui-panel-titlebar-icon ui-corner-all ui-state-default"/>   
                    </f:facet>
                </p:panel>

            </p:dataGrid>





            <p:chart  type="bar"  rendered="false"/> 
            <h:outputLabel  value="#{mainBean.generateDialogContainers()}"/>



            <p:remoteCommand name="updatechartsgrid"  update=":formCentre:chartsGrid" action="#{randomBean.getRandom(1)}" process=":formCentre:chartsGrid" />

        </h:form>

        <p:dialog widgetVar="exportChart" showEffect="fade" modal="true" header="Right-click on the chart to copy/save it as image." resizable="false"  >
            <p:outputPanel id="outputChart" layout="block"/>
        </p:dialog>

        <p:spacer />
        <div class="footer">©&nbsp;Copyright&nbsp;2014-2016&nbsp;
            <a href="http://www.acpfg.com.au/">Australian&nbsp;Centre&nbsp;for&nbsp;Plant&nbsp;Functional&nbsp;Genomics</a></div>

    </body>
    <script type="text/javascript">
        window.onresize = function (event) {
            updatechartsgrid();
        }
    </script>
    <script type="text/javascript">
        function exportChart(xhr, status, args) {
            var gene = args.exportChart;
//            alert(gene);            
            //export image
//            $('#outputChart').empty().append(PF('Traes_3DS_310A77808' ).exportAsImage());
            $('#outputChart').empty().append(PF(gene).exportAsImage());
            //show the dialog
            PF('exportChart').show();
        }
    </script>
</f:view>
</html>

